<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Omnibees Roadmap</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #f4f3ef;
  --white: #ffffff;
  --dark: #1a1a1a;
  --mid: #444;
  --muted: #888;
  --border: #e0ddd6;
  --accent: #1a1a1a;
  --now-bg: #1a1a1a;
  --now-text: #ffffff;
  --next-bg: #ffffff;
  --next-text: #1a1a1a;
  --future-bg: #f4f3ef;
  --future-text: #1a1a1a;
  --risk-red: #e63946;
  --risk-orange: #f4a261;
  --risk-yellow: #e9c46a;
  --progress-bg: #e0ddd6;
  --progress-fill: #1a1a1a;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--dark);
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
}

/* â”€â”€ LOGIN â”€â”€ */
#loginScreen {
  position: fixed; inset: 0;
  background: var(--dark);
  display: flex; align-items: center; justify-content: center;
  z-index: 100;
  transition: opacity .5s, visibility .5s;
}
#loginScreen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.login-box {
  text-align: center;
  width: 340px;
}
.login-title {
  font-family: 'Syne', sans-serif;
  font-size: 2.4rem;
  font-weight: 800;
  color: #fff;
  letter-spacing: -1px;
  margin-bottom: 4px;
}
.login-title span { color: #f4a261; }
.login-sub { color: #666; font-size: .85rem; margin-bottom: 40px; }

.login-input {
  width: 100%;
  background: #2a2a2a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 14px 18px;
  color: #fff;
  font-family: 'Inter', sans-serif;
  font-size: .95rem;
  outline: none;
  text-align: center;
  letter-spacing: 4px;
  margin-bottom: 12px;
  transition: border-color .2s;
}
.login-input:focus { border-color: #f4a261; }
.login-btn {
  width: 100%;
  padding: 14px;
  background: #f4a261;
  color: #1a1a1a;
  border: none;
  border-radius: 8px;
  font-family: 'Syne', sans-serif;
  font-size: .95rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .2s;
}
.login-btn:hover { opacity: .88; }
.login-error {
  color: #e63946;
  font-size: .8rem;
  margin-top: 10px;
  display: none;
}
.login-error.show { display: block; }

/* â”€â”€ APP â”€â”€ */
#app { display: none; min-height: 100vh; }

/* â”€â”€ HEADER â”€â”€ */
header {
  background: var(--dark);
  color: #fff;
  padding: 20px 48px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 10;
}
.logo {
  font-family: 'Syne', sans-serif;
  font-size: 1.4rem;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.logo span { color: #f4a261; }
.header-meta { display: flex; align-items: center; gap: 20px; }
.header-date { font-size: .78rem; color: #888; }
.header-refresh-info { font-size: .72rem; color: #555; white-space: nowrap; }
.header-btn {
  background: transparent;
  border: 1px solid #333;
  color: #888;
  padding: 7px 14px;
  border-radius: 6px;
  font-size: .78rem;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  transition: border-color .2s, color .2s;
}
.header-btn:hover { border-color: #f4a261; color: #f4a261; }

/* â”€â”€ MAIN â”€â”€ */
main { padding: 48px; }

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-label {
  font-family: 'Syne', sans-serif;
  font-size: .7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--muted);
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 12px;
}
.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* â”€â”€ META BLOCK â”€â”€ */
.meta-block { margin-bottom: 48px; }

.meta-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap; gap: 12px;
}
.meta-title {
  font-family: 'Syne', sans-serif;
  font-size: 1.6rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  line-height: 1.1;
}
.meta-dates {
  font-size: .78rem;
  color: var(--muted);
  margin-top: 4px;
}
.meta-pill {
  font-size: .72rem;
  font-weight: 600;
  padding: 5px 14px;
  border-radius: 99px;
  font-family: 'Syne', sans-serif;
  letter-spacing: .5px;
  white-space: nowrap;
}
.pill-now    { background: var(--dark); color: #fff; }
.pill-next   { background: var(--border); color: var(--dark); }
.pill-future { background: transparent; border: 1px solid var(--border); color: var(--muted); }

/* â”€â”€ SQUADS GRID â”€â”€ */
.squads-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

/* â”€â”€ SQUAD CARD â”€â”€ */
.squad-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}
.squad-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.squad-name {
  font-family: 'Syne', sans-serif;
  font-size: .82rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.squad-count {
  font-size: .72rem;
  color: var(--muted);
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 99px;
}

/* â”€â”€ EPIC ROW â”€â”€ */
.epic-row {
  padding: 12px 18px;
  border-bottom: 1px solid #f5f4f0;
  display: flex; flex-direction: column; gap: 8px;
}
.epic-row:last-child { border-bottom: none; }

.epic-top {
  display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
}
.epic-name {
  font-size: .85rem;
  font-weight: 500;
  line-height: 1.35;
  flex: 1;
}
.risk-badge {
  display: flex; align-items: center; gap: 4px;
  font-size: .68rem;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 4px;
  white-space: nowrap;
  flex-shrink: 0;
}
.risk-unplanned { background: #fce8ea; color: var(--risk-red); }
.risk-atrisk    { background: #fef3e2; color: #c76b00; }
.risk-long      { background: #fefae0; color: #997000; }

.epic-bottom {
  display: flex; align-items: center; gap: 10px;
}
.epic-status {
  font-size: .7rem;
  color: var(--muted);
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 4px;
}
.progress-bar {
  flex: 1;
  height: 4px;
  background: var(--progress-bg);
  border-radius: 99px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--dark);
  border-radius: 99px;
  transition: width .4s ease;
}
.progress-pct {
  font-size: .68rem;
  color: var(--muted);
  min-width: 28px;
  text-align: right;
}

/* â”€â”€ LOADING â”€â”€ */
.loading {
  text-align: center;
  padding: 80px;
  color: var(--muted);
}
.spinner {
  width: 28px; height: 28px;
  border: 2px solid var(--border);
  border-top-color: var(--dark);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin: 0 auto 14px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ ERROR â”€â”€ */
.error-box {
  background: #fce8ea;
  border: 1px solid #f5c0c4;
  border-radius: 10px;
  padding: 20px 24px;
  color: var(--risk-red);
  font-size: .85rem;
  margin-bottom: 24px;
  display: none;
}
.error-box.show { display: block; }

/* â”€â”€ EMPTY â”€â”€ */
.empty-squad {
  padding: 20px 18px;
  font-size: .8rem;
  color: var(--muted);
  text-align: center;
  font-style: italic;
}

/* â”€â”€ FUTURE GRID â”€â”€ */
.future-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
}
.future-meta-card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 18px;
}
.future-meta-name {
  font-family: 'Syne', sans-serif;
  font-size: .85rem;
  font-weight: 700;
  margin-bottom: 4px;
}
.future-meta-dates {
  font-size: .72rem;
  color: var(--muted);
  margin-bottom: 12px;
}
.future-epic-item {
  font-size: .8rem;
  padding: 5px 0;
  border-bottom: 1px solid #f5f4f0;
  display: flex; align-items: center; gap: 6px;
  color: var(--mid);
}
.future-epic-item:last-child { border-bottom: none; }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 768px) {
  main { padding: 24px 20px; }
  header { padding: 16px 20px; }
  .squads-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-title">Omni<span>Roadmap</span></div>
    <div class="login-sub">ComitÃ© de DireÃ§Ã£o Â· Omnibees Product</div>
    <input type="password" class="login-input" id="loginInput" placeholder="password" />
    <button class="login-btn" onclick="doLogin()">Entrar</button>
    <div class="login-error" id="loginError">Password incorreta</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="logo">Omni<span>Roadmap</span></div>
    <div class="header-meta">
      <span class="header-date" id="headerDate"></span>
      <span class="header-refresh-info" id="headerRefreshInfo"></span>
      <button class="header-btn" onclick="loadData()">â†» Atualizar</button>
      <button class="header-btn" onclick="doLogout()">Sair</button>
    </div>
  </header>

  <main>
    <div class="error-box" id="errorBox"></div>
    <div id="content"><div class="loading"><div class="spinner"></div><p>A carregar roadmapâ€¦</p></div></div>
  </main>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SITE_PASSWORD   = 'omnibees2024';
const WORKER_URL      = 'https://lucky-star-d742.ana-g-antunes.workers.dev';
const AUTO_REFRESH_MS = 24 * 60 * 60 * 1000; // 24 horas
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€ AUTO-REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _autoRefreshTimer = null;

function updateRefreshInfo() {
  const el = document.getElementById('headerRefreshInfo');
  if (!el) return;
  const now = new Date();
  const next = new Date(now.getTime() + AUTO_REFRESH_MS);
  el.textContent = `â†» prÃ³ximo refresh Ã s ${next.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' })}`;
}

function startAutoRefresh() {
  stopAutoRefresh();
  updateRefreshInfo();
  _autoRefreshTimer = setInterval(() => {
    loadData();
    updateRefreshInfo();
  }, AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
  if (_autoRefreshTimer) {
    clearInterval(_autoRefreshTimer);
    _autoRefreshTimer = null;
  }
}

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  if (document.getElementById('loginInput').value === SITE_PASSWORD) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('app').style.display = 'block';
    const now = new Date();
    document.getElementById('headerDate').textContent =
      now.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    loadData();
    startAutoRefresh();
  } else {
    document.getElementById('loginError').classList.add('show');
  }
}
document.getElementById('loginInput').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

function doLogout() {
  stopAutoRefresh();
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginInput').value = '';
  document.getElementById('loginScreen').classList.remove('hidden');
}

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ahaGet(path) {
  const res = await fetch(`${WORKER_URL}?path=${encodeURIComponent(path)}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

// â”€â”€â”€ LOAD DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  showLoading();
  try {
    // Get products
    const prodsData = await ahaGet('products');
    const product = prodsData.products.find(p => p.name.toLowerCase().includes('omnibees')) || prodsData.products[0];
    const ref = product.reference_prefix;

    // Get releases
    const relData = await ahaGet(`products/${ref}/releases?per_page=100`);
    const releases = relData.releases || [];

    // Classify releases by date
    const today = new Date();
    today.setHours(0,0,0,0);

    const categorized = classifyReleases(releases, today);

    // Load epics for relevant releases (current + next 2)
    const relevantReleases = [...categorized.current, ...categorized.next];
    const epicsByRelease = {};

    await Promise.all(relevantReleases.map(async rel => {
      try {
        const data = await ahaGet(`releases/${rel.id}/epics?per_page=100`);
        epicsByRelease[rel.id] = data.epics || [];
      } catch(e) {
        epicsByRelease[rel.id] = [];
      }
    }));

    // Load epics for future releases (just names, no deep fetch)
    const futureEpicsByRelease = {};
    await Promise.all(categorized.future.map(async rel => {
      try {
        const data = await ahaGet(`releases/${rel.id}/epics?per_page=100`);
        futureEpicsByRelease[rel.id] = data.epics || [];
      } catch(e) {
        futureEpicsByRelease[rel.id] = [];
      }
    }));

    renderAll(categorized, epicsByRelease, futureEpicsByRelease);
  } catch(err) {
    showError('Erro ao carregar dados: ' + err.message);
  }
}

// â”€â”€â”€ CLASSIFY RELEASES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classifyReleases(releases, today) {
  // Filter only releases matching "Meta N 2026 - Team" pattern
  const withDates = releases.filter(r =>
    /^Meta\s+\d+\s+2026\s*[-â€“]/i.test(r.name) &&
    (r.start_date || r.release_date || r.start_on)
  );

  const parsed = withDates.map(r => ({
    ...r,
    _start: parseDate(r.start_date || r.start_on),
    _end:   parseDate(r.release_date || r.end_date),
  })).filter(r => r._start || r._end);

  // Sort by start date
  parsed.sort((a, b) => {
    const aDate = a._start || a._end;
    const bDate = b._start || b._end;
    return aDate - bDate;
  });

  const current = [], next = [], future = [];

  for (const r of parsed) {
    const start = r._start || new Date(0);
    const end   = r._end   || new Date(9999,0,1);

    if (start <= today && end >= today) {
      current.push(r);
    } else if (start > today) {
      if (next.length < 2) next.push(r);
      else future.push(r);
    }
  }

  // If nothing is "current", take the most recent past release
  if (current.length === 0 && parsed.length > 0) {
    const past = parsed.filter(r => (r._end || new Date(0)) < today);
    if (past.length) current.push(past[past.length - 1]);
  }

  return { current, next, future };
}

function parseDate(str) {
  if (!str) return null;
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

// â”€â”€â”€ GROUP BY SQUAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function groupBySquad(epics) {
  const squads = {};
  for (const epic of epics) {
    // Try to get squad from team name, product area, or parse from name
    const squad = getSquad(epic);
    if (!squads[squad]) squads[squad] = [];
    squads[squad].push(epic);
  }
  return squads;
}

function getSquad(epic) {
  // Try initiative/team tags
  if (epic.teams && epic.teams.length) return epic.teams[0].name;
  if (epic.initiative && epic.initiative.name) return epic.initiative.name;
  // Try to parse "Meta X 2026 - SquadName" pattern from release name
  if (epic.release && epic.release.name) {
    const m = epic.release.name.match(/[-â€“]\s*(.+)$/);
    if (m) return m[1].trim();
  }
  return 'Geral';
}

// â”€â”€â”€ DELIVERY RISK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getRisk(epic) {
  const flags = epic.score_facts || epic.delivery_risks || [];
  // Check native delivery risk field
  if (epic.due_date_risk) {
    const r = epic.due_date_risk.toLowerCase();
    if (r.includes('unplanned') || r.includes('nÃ£o planeado') || r.includes('not planned')) return 'unplanned';
    if (r.includes('risk') || r.includes('risco'))  return 'atrisk';
    if (r.includes('long') || r.includes('longa'))  return 'long';
  }
  // Check flags array
  if (Array.isArray(epic.flags) && epic.flags.length > 0) {
    const f = (epic.flags[0].name || '').toLowerCase();
    if (f.includes('nÃ£o planeado') || f.includes('unplanned')) return 'unplanned';
    if (f.includes('risco') || f.includes('risk'))             return 'atrisk';
    if (f.includes('longa') || f.includes('long'))             return 'long';
  }
  return null;
}

function riskBadge(risk) {
  if (!risk) return '';
  const map = {
    unplanned: ['âš  NÃ£o planeado', 'risk-unplanned'],
    atrisk:    ['âš¡ Em risco',     'risk-atrisk'],
    long:      ['â³ Entrega longa','risk-long'],
  };
  const [label, cls] = map[risk];
  return `<span class="risk-badge ${cls}">${label}</span>`;
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(cat, epicsByRelease, futureEpicsByRelease) {
  let html = '';

  // â”€â”€ CURRENT â”€â”€
  if (cat.current.length) {
    html += `<div class="section-label">Meta em curso</div>`;
    for (const rel of cat.current) {
      const epics = epicsByRelease[rel.id] || [];
      html += renderMetaBlock(rel, epics, 'now');
    }
  }

  // â”€â”€ NEXT â”€â”€
  if (cat.next.length) {
    html += `<div class="section-label" style="margin-top:48px">PrÃ³ximas metas</div>`;
    for (const rel of cat.next) {
      const epics = epicsByRelease[rel.id] || [];
      html += renderMetaBlock(rel, epics, 'next');
    }
  }

  // â”€â”€ FUTURE â”€â”€
  if (cat.future.length) {
    html += `<div class="section-label" style="margin-top:48px">Metas futuras</div>`;
    html += `<div class="future-grid">`;
    for (const rel of cat.future) {
      const epics = futureEpicsByRelease[rel.id] || [];
      html += renderFutureCard(rel, epics);
    }
    html += `</div>`;
  }

  document.getElementById('content').innerHTML = html;
}

function renderMetaBlock(rel, epics, type) {
  const pillClass = type === 'now' ? 'pill-now' : 'pill-next';
  const pillLabel = type === 'now' ? 'â— Em curso' : 'â—‹ A seguir';
  const dates = formatDateRange(rel._start, rel._end);

  const squads = groupBySquad(epics);
  const squadNames = Object.keys(squads).sort();

  let squadsHtml = '';
  if (squadNames.length === 0) {
    squadsHtml = `<div style="color:var(--muted);font-size:.85rem;padding:16px 0">Sem Ã©picos associados a esta meta.</div>`;
  } else {
    squadsHtml = `<div class="squads-grid">`;
    for (const squad of squadNames) {
      const squadEpics = squads[squad];
      squadsHtml += `
        <div class="squad-card">
          <div class="squad-header">
            <span class="squad-name">${squad}</span>
            <span class="squad-count">${squadEpics.length} Ã©pico${squadEpics.length !== 1 ? 's' : ''}</span>
          </div>
          ${squadEpics.map(renderEpicRow).join('')}
        </div>`;
    }
    squadsHtml += `</div>`;
  }

  return `
    <div class="meta-block">
      <div class="meta-header">
        <div>
          <div class="meta-title">${rel.name}</div>
          <div class="meta-dates">${dates}</div>
        </div>
        <span class="meta-pill ${pillClass}">${pillLabel}</span>
      </div>
      ${squadsHtml}
    </div>`;
}

function renderEpicRow(epic) {
  const status   = epic.workflow_status?.name || 'â€”';
  const progress = epic.progress !== undefined ? Math.round(epic.progress) : null;
  const risk     = getRisk(epic);

  return `
    <div class="epic-row">
      <div class="epic-top">
        <span class="epic-name">${epic.name}</span>
        ${riskBadge(risk)}
      </div>
      <div class="epic-bottom">
        <span class="epic-status">${status}</span>
        ${progress !== null ? `
          <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
          <span class="progress-pct">${progress}%</span>
        ` : ''}
      </div>
    </div>`;
}

function renderFutureCard(rel, epics) {
  const dates = formatDateRange(rel._start, rel._end);
  const items = epics.slice(0, 8).map(e => {
    const risk = getRisk(e);
    const dot = risk === 'unplanned' ? 'ğŸ”´' : risk === 'atrisk' ? 'ğŸŸ¡' : risk === 'long' ? 'ğŸŸ ' : 'Â·';
    return `<div class="future-epic-item"><span>${dot}</span> ${e.name}</div>`;
  }).join('');
  const more = epics.length > 8 ? `<div class="future-epic-item" style="color:var(--muted)">+ ${epics.length - 8} mais</div>` : '';

  return `
    <div class="future-meta-card">
      <div class="future-meta-name">${rel.name}</div>
      <div class="future-meta-dates">${dates}</div>
      ${items || '<div style="color:var(--muted);font-size:.78rem">Sem Ã©picos definidos</div>'}
      ${more}
    </div>`;
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDateRange(start, end) {
  const fmt = d => d ? d.toLocaleDateString('pt-PT', { day: 'numeric', month: 'short', year: 'numeric' }) : '?';
  if (start && end) return `${fmt(start)} â†’ ${fmt(end)}`;
  if (start) return `A partir de ${fmt(start)}`;
  if (end)   return `AtÃ© ${fmt(end)}`;
  return '';
}

function showLoading() {
  document.getElementById('content').innerHTML =
    '<div class="loading"><div class="spinner"></div><p>A carregar roadmapâ€¦</p></div>';
  document.getElementById('errorBox').classList.remove('show');
}

function showError(msg) {
  document.getElementById('errorBox').textContent = msg;
  document.getElementById('errorBox').classList.add('show');
  document.getElementById('content').innerHTML = '';
}
</script>
</body>
</html>
